<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WALZ EXPLOIT PANEL</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <div id="toast-box"></div>

    <div id="login-overlay">
        <div class="login-card">
            <h1 class="login-title">WALZ <span style="color:var(--primary)">EXPLOIT</span></h1>
            <p style="color: var(--text-mute); font-size: 12px;">Sistem Kontrol Bot WhatsApp Profesional</p>
            
            <input type="text" id="token-input" class="login-input" placeholder="Masukkan Token Akses (Dari Telegram)" autocomplete="off">
            
            <button onclick="authLogin()" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;">
                üîê MASUK DASHBOARD
            </button>
        </div>
    </div>

    <div id="editor-overlay">
        <div class="editor-box">
            <div class="editor-header">
                <span id="editor-filename" style="font-family: 'JetBrains Mono'; font-size: 12px;">file.js</span>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-secondary btn-icon" onclick="closeEditor()" title="Tutup">‚úï</button>
                    <button class="btn btn-primary" onclick="saveFile()">üíæ Simpan</button>
                </div>
            </div>
            <textarea id="code-content" spellcheck="false" placeholder="Loading content..."></textarea>
        </div>
    </div>

    <nav>
        <div class="brand">
            <span>‚ö°</span> WALZ EXPLOIT
        </div>
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchPage('console')">Console</button>
            <button class="tab-btn" onclick="switchPage('files')">Files</button>
        </div>
    </nav>

    <div class="container">
        
        <main id="p-console" class="page active">
            <div class="status-grid">
                <div class="stat-card">
                    <div class="stat-title">Bot Status</div>
                    <div class="stat-value" id="stat-status">
                        <span class="status-dot"></span> OFFLINE
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">RAM Usage</div>
                    <div class="stat-value" id="stat-ram">-- MB</div>
                </div>
            </div>

            <div class="console-actions">
                <button class="btn btn-primary" onclick="req('/start')">‚ñ∂ Start Bot</button>
                <button class="btn btn-secondary" onclick="req('/restart')">‚Üª Restart</button>
                <button class="btn btn-danger" onclick="req('/stop')">‚ñ† Stop Bot</button>
            </div>

            <div class="terminal-wrapper">
                <div class="terminal-output" id="logs">
                    <div style="color: #666; margin-bottom: 10px;">Welcome to Walz Exploit v1.0.0...</div>
                </div>
                <div class="terminal-input-bar">
                    <span class="prompt">$</span>
                    <input type="text" id="cmd" class="cmd-input" placeholder="Ketik perintah command disini..." autocomplete="off">
                </div>
            </div>
        </main>

        <main id="p-files" class="page">
            <div class="file-toolbar">
                <div style="display: flex; gap: 8px; align-items: center; width: 100%;">
                    <button class="btn btn-secondary btn-icon" onclick="goUpDir()">‚¨Ü</button>
                    <div class="path-bread" id="current-path">/</div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 5px;">
                    <button class="btn btn-primary" onclick="document.getElementById('up').click()">+ Upload Zip</button>
                    <button class="btn btn-secondary" onclick="loadFiles()">‚Üª Refresh</button>
                </div>
                <input type="file" id="up" style="display: none;" onchange="upload()">
            </div>
            
            <div class="file-grid" id="file-list">
                </div>
        </main>

    </div>

    <script>
        const socket = io();
        let currentPath = '';
        let editingFile = '';

        if (localStorage.getItem('walz_token')) {
            document.getElementById('login-overlay').style.display = 'none';
        }

        function authLogin() {
            const token = document.getElementById('token-input').value;
            if(!token) return showToast('Masukkan token!', 'error');

            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    localStorage.setItem('walz_token', token);
                    document.getElementById('login-overlay').style.display = 'none';
                    showToast('Login Berhasil', 'success');
                    if(data.warning) showToast(data.warning, 'warning');
                    loadFiles('');
                } else {
                    showToast('Token Salah / Kadaluarsa', 'error');
                }
            })
            .catch(() => showToast('Koneksi Gagal', 'error'));
        }

        function getAuthHeaders() {
            return {
                'Authorization': localStorage.getItem('walz_token'),
                'Content-Type': 'application/json'
            };
        }

        function req(url, body = {}) {
            fetch(url, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(body)
            })
            .then(res => res.json())
            .then(data => {
                showToast(data.msg, data.success ? 'success' : 'error');
                if(url === '/restart') setTimeout(() => req('/start'), 2000);
            });
        }

        socket.on('log', (data) => {
            const logDiv = document.getElementById('logs');
            let formatted = data.replace(/</g, '&lt;')
                .replace(/\x1b\[31m/g, '<span class="text-danger">')
                .replace(/\x1b\[32m/g, '<span class="text-success">')
                .replace(/\x1b\[33m/g, '<span class="text-warning">')
                .replace(/\x1b\[36m/g, '<span class="text-info">')
                .replace(/\x1b\[0m/g, '</span>');
            
            logDiv.innerHTML += formatted;
            if (document.getElementById('p-console').classList.contains('active')) {
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        });

        socket.on('stats', (data) => {
            document.getElementById('stat-ram').innerText = data.ram;
            const statusDiv = document.getElementById('stat-status');
            if (data.status === 'ONLINE') {
                statusDiv.innerHTML = '<span class="status-dot online"></span> <span class="text-success">ONLINE</span>';
            } else {
                statusDiv.innerHTML = '<span class="status-dot"></span> <span style="color:#777">OFFLINE</span>';
            }
        });

        document.getElementById('cmd').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const val = e.target.value;
                if (val.trim()) {
                    socket.emit('input', val);
                    e.target.value = '';
                }
            }
        });

        function loadFiles(path = currentPath) {
            fetch('/files', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ path })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success && data.data) return;

                currentPath = data.currentPath || '';
                document.getElementById('current-path').innerText = currentPath || '/';
                const list = document.getElementById('file-list');
                list.innerHTML = '';

                if (data.data.length === 0) {
                    list.innerHTML = '<div style="color:#555; padding:20px; text-align:center; grid-column: 1/-1;">Folder Kosong</div>';
                    return;
                }

                data.data.forEach(file => {
                    const icon = file.isDir ? 'üìÇ' : 'üìÑ';
                    const safePath = file.path.replace(/\\/g, '/');
                    const clickAction = file.isDir ? `loadFiles('${safePath}')` : `openEditor('${safePath}')`;

                    let buttons = '';
                    if (file.name.endsWith('.zip')) {
                        buttons += `<button class="btn btn-secondary btn-icon" onclick="act('/unzip', '${safePath}')" title="Extract">üì¶</button>`;
                    }
                    buttons += `<button class="btn btn-danger btn-icon" onclick="act('/delete', '${safePath}')" title="Delete">üóë</button>`;

                    const html = `
                    <div class="file-item">
                        <div class="file-info" onclick="${clickAction}">
                            <span class="file-icon">${icon}</span>
                            <span class="file-name">${file.name}</span>
                        </div>
                        <div style="display:flex; gap:5px;">
                            ${buttons}
                        </div>
                    </div>`;
                    list.innerHTML += html;
                });
            })
            .catch(() => showToast('Gagal memuat file', 'error'));
        }

        function goUpDir() {
            if (!currentPath || currentPath === '') return;
            const parts = currentPath.split('/');
            parts.pop();
            loadFiles(parts.join('/'));
        }

        function act(endpoint, filename) {
            if (confirm('Apakah anda yakin?')) {
                req(endpoint, { filename });
                setTimeout(() => loadFiles(currentPath), 1000);
            }
        }

        function upload() {
            const fileInput = document.getElementById('up');
            if(fileInput.files.length === 0) return;

            const fd = new FormData();
            fd.append('file', fileInput.files[0]);
            
            showToast('Mengupload...', 'warning');
            fetch('/upload', { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                showToast('Upload Selesai', 'success');
                loadFiles(currentPath);
            });
        }

        function openEditor(filePath) {
            fetch('/read', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ path: filePath })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    editingFile = filePath;
                    document.getElementById('editor-filename').innerText = filePath;
                    document.getElementById('code-content').value = data.content;
                    document.getElementById('editor-overlay').style.display = 'flex';
                } else {
                    showToast('Gagal membaca file', 'error');
                }
            });
        }

        function saveFile() {
            const content = document.getElementById('code-content').value;
            req('/save', { path: editingFile, content });
            document.getElementById('editor-overlay').style.display = 'none';
        }

        function closeEditor() {
            document.getElementById('editor-overlay').style.display = 'none';
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('p-' + pageId).classList.add('active');
            const tabs = document.querySelectorAll('.tab-btn');
            if(pageId === 'console') tabs[0].classList.add('active');
            if(pageId === 'files') {
                tabs[1].classList.add('active');
                loadFiles(currentPath);
            }
        }

        function showToast(msg, type = 'success') {
            const box = document.getElementById('toast-box');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerText = msg;
            box.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(100%)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>