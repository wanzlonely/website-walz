<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevConsole v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #09090b;
            --panel: #18181b;
            --border: #27272a;
            --text: #e4e4e7;
            --text-dim: #a1a1aa;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;
            --font-main: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Layout */
        header { 
            height: 60px; background: var(--panel); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .brand { font-weight: 600; font-size: 18px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .sys-stats { font-size: 12px; color: var(--text-dim); display: flex; gap: 15px; font-family: var(--font-code); }
        .stat-item span { color: var(--accent); font-weight: bold; }

        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        aside { width: 300px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); }
        .file-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .file-card { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 6px; 
            padding: 12px; margin-bottom: 8px; transition: 0.2s;
        }
        .file-card:hover { border-color: var(--accent); background: rgba(59, 130, 246, 0.05); }
        .file-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .file-name { font-family: var(--font-code); font-size: 13px; font-weight: 500; }
        .status-badge { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .status-badge.running { background: var(--success); box-shadow: 0 0 8px rgba(34, 197, 94, 0.4); }
        
        .btn-group { display: flex; gap: 5px; }
        button { 
            flex: 1; padding: 6px; border: none; border-radius: 4px; font-size: 11px; font-weight: 600; 
            cursor: pointer; transition: 0.2s; color: white;
        }
        .btn-run { background: var(--border); color: var(--text); }
        .btn-run:hover { background: var(--success); color: #000; }
        .btn-stop { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .btn-stop:hover { background: var(--danger); color: white; }
        .btn-edit { background: var(--border); }
        .btn-edit:hover { background: var(--accent); }
        .btn-del { background: transparent; color: var(--text-dim); }
        .btn-del:hover { color: var(--danger); }

        /* Terminal Area */
        main { flex: 1; background: #000; display: flex; flex-direction: column; padding: 20px; position: relative; }
        .terminal-window { 
            flex: 1; background: #0c0c0c; border: 1px solid var(--border); border-radius: 6px; 
            padding: 15px; font-family: var(--font-code); font-size: 13px; line-height: 1.5; 
            overflow-y: auto; color: #d4d4d8; white-space: pre-wrap; 
        }
        
        /* Upload Section */
        .upload-section { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; }
        .file-input-wrapper { display: flex; gap: 10px; }
        input[type="file"] { color: var(--text-dim); font-size: 12px; }
        .upload-btn { background: var(--accent); padding: 8px 15px; border-radius: 4px; width: auto; flex: unset; }

        /* Login Overlay */
        #login-overlay { 
            position: fixed; inset: 0; background: rgba(9, 9, 11, 0.95); z-index: 50; 
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .login-box { background: var(--panel); padding: 30px; border-radius: 12px; border: 1px solid var(--border); width: 350px; text-align: center; }
        .login-box input { width: 100%; background: var(--bg); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 6px; margin: 20px 0; }
        .login-box button { width: 100%; background: var(--text); color: black; padding: 12px; font-size: 14px; }

        /* Editor Overlay */
        #editor-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 40; padding: 40px; display: none; }
        .editor-modal { background: var(--panel); height: 100%; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .editor-head { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .editor-content { flex: 1; background: #0c0c0c; color: #fff; border: none; padding: 20px; font-family: var(--font-code); resize: none; font-size: 14px; }
        
        /* Toast */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--panel); border: 1px solid var(--border); padding: 12px 20px; border-radius: 6px; font-size: 13px; animation: slideIn 0.3s; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ANSI Colors */
        .ansi-red { color: #ef4444; } .ansi-green { color: #22c55e; } .ansi-yellow { color: #eab308; } .ansi-blue { color: #3b82f6; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            aside { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid var(--border); }
            main { height: 60%; }
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-bottom: 5px;">Console Access</h2>
            <p style="color: var(--text-dim); font-size: 13px;">Enter passphrase to continue</p>
            <input type="password" id="passInput" placeholder="Password">
            <button onclick="login()">Authenticate</button>
        </div>
    </div>

    <header>
        <div class="brand">
            <span style="color:var(--accent)">âš¡</span> NODE CONTROLLER
        </div>
        <div class="sys-stats" id="sysStats">
            <div class="stat-item">RAM: <span>-</span></div>
            <div class="stat-item">OS: <span>-</span></div>
        </div>
    </header>

    <div class="main-container">
        <aside>
            <div class="sidebar-header">
                <form action="/upload" method="POST" enctype="multipart/form-data" class="file-input-wrapper">
                    <input type="file" name="scriptFile" style="width: 130px;" required>
                    <button type="submit" class="upload-btn">Upload</button>
                </form>
            </div>
            <div class="file-list" id="fileList">
                </div>
        </aside>

        <main>
            <div class="terminal-window" id="terminal"></div>
        </main>
    </div>

    <div id="editor-overlay">
        <div class="editor-modal">
            <div class="editor-head">
                <span id="editorFileName" style="font-family: var(--font-code);">script.js</span>
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveFile()" class="upload-btn">Save Changes</button>
                    <button onclick="closeEditor()" class="btn-del">Close</button>
                </div>
            </div>
            <textarea class="editor-content" id="editorCode"></textarea>
        </div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const term = document.getElementById('terminal');
        let activeBots = [];

        // --- Socket Listeners ---
        socket.on('log', (data) => {
            // Simple ANSI color parsing
            let formatted = data
                .replace(/\x1b\[31m/g, '<span class="ansi-red">')
                .replace(/\x1b\[32m/g, '<span class="ansi-green">')
                .replace(/\x1b\[33m/g, '<span class="ansi-yellow">')
                .replace(/\x1b\[36m/g, '<span class="ansi-blue">')
                .replace(/\x1b\[0m/g, '</span>');
            
            term.innerHTML += formatted;
            term.scrollTop = term.scrollHeight;
        });

        socket.on('status_update', (list) => {
            activeBots = list;
            refreshFiles();
        });

        socket.on('sys_stats', (stats) => {
            document.getElementById('sysStats').innerHTML = `
                <div class="stat-item">RAM: <span>${stats.ram}</span></div>
                <div class="stat-item">HOST: <span>${stats.total}</span></div>
            `;
        });

        // --- Functions ---
        function login() {
            const pass = document.getElementById('passInput').value;
            fetch('/login', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({password: pass})
            }).then(r=>r.json()).then(d=>{
                if(d.success) {
                    document.getElementById('login-overlay').style.display = 'none';
                    refreshFiles();
                    showToast('Authenticated', 'success');
                } else showToast('Wrong Password', 'error');
            });
        }

        function refreshFiles() {
            fetch('/files').then(r=>r.json()).then(files => {
                const container = document.getElementById('fileList');
                container.innerHTML = '';
                files.forEach(f => {
                    const isRunning = activeBots.includes(f);
                    const btnHtml = isRunning 
                        ? `<button class="btn-stop" onclick="action('/stop', '${f}')">STOP</button>` 
                        : `<button class="btn-run" onclick="action('/start', '${f}')">RUN</button>`;
                    
                    container.innerHTML += `
                        <div class="file-card">
                            <div class="file-head">
                                <span class="file-name">${f}</span>
                                <div class="status-badge ${isRunning ? 'running' : ''}"></div>
                            </div>
                            <div class="btn-group">
                                ${btnHtml}
                                <button class="btn-edit" onclick="openEditor('${f}')">EDIT</button>
                                <button class="btn-del" onclick="delFile('${f}')">DEL</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function action(endpoint, filename) {
            fetch(endpoint, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({filename})
            }).then(r=>r.json()).then(d => {
                showToast(d.msg, d.success ? 'success' : 'error');
            });
        }

        function delFile(f) {
            if(confirm('Delete '+f+'?')) {
                action('/delete', f);
                setTimeout(refreshFiles, 500);
            }
        }

        function openEditor(f) {
            fetch('/read', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({filename: f})
            }).then(r=>r.json()).then(d => {
                document.getElementById('editor-overlay').style.display = 'block';
                document.getElementById('editorFileName').innerText = f;
                document.getElementById('editorCode').value = d.content;
            });
        }

        function saveFile() {
            const f = document.getElementById('editorFileName').innerText;
            const c = document.getElementById('editorCode').value;
            fetch('/save', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({filename: f, content: c})
            }).then(r=>r.json()).then(d => {
                if(d.success) {
                    showToast('File Saved', 'success');
                    closeEditor();
                } else showToast('Save Failed', 'error');
            });
        }

        function closeEditor() {
            document.getElementById('editor-overlay').style.display = 'none';
        }

        function showToast(msg, type) {
            const t = document.getElementById('toasts');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerText = msg;
            t.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
    </script>
</body>
</html>
