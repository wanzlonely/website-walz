<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WALZ EXPLOIT V3</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="toast-container"></div>

    <div id="view-login">
        <div class="login-card">
            <div class="brand-title">WALZ<span>EXPLOIT</span></div>
            <p class="brand-desc">Professional Bot Controller Interface</p>
            <div class="input-group">
                <input type="text" id="token-input" placeholder="Masukkan Token / Password" autocomplete="off">
            </div>
            <button class="btn-main" onclick="auth()">MASUK DASHBOARD</button>
            <p style="margin-top: 25px; font-size: 12px; color: #555;">Gunakan password admin jika token error.</p>
        </div>
    </div>

    <div class="app-content">
        <div id="tab-console" class="tab-view active">
            <div class="page-header">
                <div class="page-title">Console</div>
                <div class="status-pill">
                    <span class="dot" id="status-dot"></span>
                    <span id="status-text">OFFLINE</span>
                </div>
            </div>

            <div class="console-box">
                <div class="console-log" id="logs"></div>
                <div class="console-input-area">
                    <span style="color:var(--primary)">$</span>
                    <input type="text" id="cmd-input" class="console-input" placeholder="Ketik perintah...">
                </div>
            </div>

            <div class="action-grid">
                <button class="btn-action btn-start" onclick="req('/start')">‚ñ∂ MULAI BOT</button>
                <button class="btn-action btn-stop" onclick="req('/stop')">‚ñ† STOP</button>
            </div>
        </div>

        <div id="tab-files" class="tab-view">
            <div class="page-header">
                <div class="page-title">Manager</div>
                <div class="status-pill" onclick="document.getElementById('up').click()" style="cursor:pointer; border-color:var(--primary); color:var(--primary);">
                    + Upload
                </div>
                <input type="file" id="up" hidden onchange="uploadFile()">
            </div>

            <div class="path-display">
                <span id="current-path">/</span>
                <button onclick="goUp()" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;">‚¨Ü</button>
            </div>

            <div class="file-grid" id="file-list"></div>
        </div>
    </div>

    <div id="editor-view">
        <div class="editor-toolbar">
            <button onclick="closeEditor()" style="background:none; border:none; color:#ef4444; font-size:24px; cursor:pointer;">‚úï</button>
            <span id="editor-filename" style="font-family:'JetBrains Mono'; font-size:13px; color:#fff;">script.js</span>
            <button onclick="saveFile()" style="background:none; border:none; color:var(--primary); font-size:24px; cursor:pointer;">‚úî</button>
        </div>
        <textarea id="editor-textarea" spellcheck="false"></textarea>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('console')">
            <div class="nav-icon">‚ö°</div>
            <span>Console</span>
        </button>
        <button class="nav-btn" onclick="switchTab('files')">
            <div class="nav-icon">üìÇ</div>
            <span>Files</span>
        </button>
    </div>

    <script>
        const socket = io();
        let currentPath = '';
        let editingPath = '';

        if(localStorage.getItem('walz_auth')) {
            document.getElementById('view-login').classList.add('hidden');
        }

        function auth() {
            const t = document.getElementById('token-input').value;
            fetch('/login', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({token: t})
            }).then(r=>r.json()).then(d => {
                if(d.success) {
                    localStorage.setItem('walz_auth', t);
                    document.getElementById('view-login').classList.add('hidden');
                    toast(d.msg || 'Login Berhasil');
                    loadFiles();
                } else {
                    toast(d.msg || 'Token Salah');
                    document.getElementById('token-input').value = '';
                }
            });
        }

        function getHeaders() { 
            return {'Authorization': localStorage.getItem('walz_auth'), 'Content-Type': 'application/json'}; 
        }
        function req(u, b={}) {
            fetch(u, {method:'POST', headers:getHeaders(), body:JSON.stringify(b)})
            .then(r=>r.json()).then(d => toast(d.msg || (d.success?'Sukses':'Gagal')));
        }
        function toast(msg) {
            const d = document.createElement('div'); d.className = 'toast'; d.innerText = msg;
            document.getElementById('toast-container').appendChild(d);
            setTimeout(()=>d.remove(), 2500);
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
            if(id === 'files') loadFiles();
        }

        socket.on('log', d => {
            const l = document.getElementById('logs');
            l.innerHTML += d.replace(/\x1b\[32m/g, '<span class="ansi-green">')
                            .replace(/\x1b\[31m/g, '<span class="ansi-red">')
                            .replace(/\x1b\[33m/g, '<span class="ansi-yellow">')
                            .replace(/\x1b\[0m/g, '</span>');
            l.scrollTop = l.scrollHeight;
        });
        socket.on('stats', d => {
            document.getElementById('status-text').innerText = d.status;
            document.getElementById('status-dot').className = 'dot ' + (d.status==='ONLINE'?'online':'');
        });
        document.getElementById('cmd-input').addEventListener('keydown', e => {
            if(e.key === 'Enter') { socket.emit('input', e.target.value); e.target.value = ''; }
        });

        function loadFiles(path = currentPath) {
            fetch('/files', {method:'POST', headers:getHeaders(), body:JSON.stringify({path})})
            .then(r=>r.json()).then(d => {
                if(!d.success) return;
                currentPath = d.currentPath;
                document.getElementById('current-path').innerText = currentPath || '/';
                const list = document.getElementById('file-list');
                list.innerHTML = '';
                d.data.forEach(f => {
                    const safePath = f.path.replace(/'/g, "\\'");
                    const icon = f.isDir ? 'üìÅ' : 'üìÑ';
                    const action = f.isDir ? `loadFiles('${safePath}')` : `openEditor('${safePath}')`;
                    
                    let btns = `<button style="background:none;border:none;color:#ef4444;font-size:16px;cursor:pointer" onclick="act('/delete','${safePath}')">üóë</button>`;
                    if(f.name.endsWith('.zip')) btns = `<button style="background:none;border:none;color:#fff;font-size:16px;margin-right:10px;cursor:pointer" onclick="act('/unzip','${safePath}')">üì¶</button>` + btns;

                    list.innerHTML += `
                    <div class="file-card">
                        <div class="file-info" onclick="${action}">
                            <div style="font-size:20px">${icon}</div>
                            <div class="file-name">${f.name}</div>
                        </div>
                        <div>${btns}</div>
                    </div>`;
                });
            });
        }

        function goUp() {
            if(!currentPath) return;
            const s = currentPath.split('/'); s.pop(); loadFiles(s.join('/'));
        }

        function uploadFile() {
            const f = document.getElementById('up').files[0];
            const fd = new FormData(); fd.append('file', f);
            toast('Mengupload...');
            fetch('/upload', {method:'POST', body:fd}).then(() => { toast('Upload Selesai'); loadFiles(); });
        }

        function act(u, n) { if(confirm('Lanjutkan aksi ini?')) req(u, {filename:n}); setTimeout(()=>loadFiles(currentPath), 500); }

        function openEditor(p) {
            fetch('/read', {method:'POST', headers:getHeaders(), body:JSON.stringify({path:p})})
            .then(r=>r.json()).then(d => {
                if(d.success) {
                    editingPath = p;
                    document.getElementById('editor-filename').innerText = p;
                    document.getElementById('editor-textarea').value = d.content;
                    document.getElementById('editor-view').classList.add('open');
                }
            });
        }
        function saveFile() {
            req('/save', {path:editingPath, content:document.getElementById('editor-textarea').value});
            closeEditor();
        }
        function closeEditor() { document.getElementById('editor-view').classList.remove('open'); }
    </script>
</body>
</html>