<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS CONTROL PANEL</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <div id="toast-box"></div>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="font-weight: 800; letter-spacing: -1px; margin-bottom: 8px;">SYSTEM LOGIN</h2>
            <p style="color: var(--text-mute); font-size: 13px;">Masukkan kode akses administrator</p>
            
            <input type="password" id="pass" class="login-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off">
            <button onclick="login()" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;">MASUK DASHBOARD</button>
        </div>
    </div>

    <nav>
        <div class="brand">
            <span style="font-size: 20px;">âš¡</span> NEXUS
        </div>
        <div class="nav-right">
            <div class="tabs">
                <div class="tab active" onclick="switchPage('console')">Console</div>
                <div class="tab" onclick="switchPage('files')">Files</div>
            </div>
            <button class="btn-icon" onclick="toggleTheme()" title="Ganti Tema">
                ðŸŒ—
            </button>
        </div>
    </nav>

    <main id="p-console" class="page active">
        <div class="console-header">
            <div>
                <h3 style="font-size: 16px; font-weight: 600;">Server Control</h3>
                <p style="font-size: 12px; color: var(--text-mute); margin-top: 4px;">Kelola proses bot secara realtime</p>
            </div>
            <div class="console-actions">
                <button class="btn btn-primary" onclick="req('/start')">â–¶ Start</button>
                <button class="btn" onclick="req('/restart')">â†» Restart</button>
                <button class="btn btn-danger" onclick="req('/stop')">â–  Stop</button>
            </div>
        </div>

        <div class="terminal-box">
            <div class="terminal-logs" id="logs"></div>
            <div class="terminal-input">
                <span class="prompt-char">âžœ</span>
                <input type="text" id="cmd" class="cmd-input" placeholder="Ketik perintah command disini..." autocomplete="off">
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">RAM Usage</div>
                <div class="stat-value" id="stat-ram">-- MB</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">CPU Load</div>
                <div class="stat-value" id="stat-cpu">-- %</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Server Time</div>
                <div class="stat-value" id="stat-time">--:--:--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Status</div>
                <div class="stat-value">
                    <span id="stat-dot" class="stat-indicator"></span>
                    <span id="stat-text" style="font-size: 14px;">OFFLINE</span>
                </div>
            </div>
        </div>
    </main>

    <main id="p-files" class="page">
        <div class="file-toolbar">
            <button class="btn btn-primary" onclick="document.getElementById('up').click()">+ Upload Script (.zip)</button>
            <input type="file" id="up" style="display: none;" onchange="upload()">
        </div>
        
        <div class="file-table">
            <div class="file-header">
                <div style="width: 40px;"></div>
                <div style="flex: 1;">Filename</div>
                <div style="width: 140px;">Actions</div>
            </div>
            <div class="file-list" id="file-list"></div>
        </div>
    </main>

    <script>
        const socket = io();
        
        if (localStorage.getItem('nexus_auth') === 'true') {
            document.getElementById('login-overlay').style.display = 'none';
        }
        
        document.getElementById('pass').addEventListener('keydown', e => { if(e.key === 'Enter') login(); });

        function login() {
            const p = document.getElementById('pass').value;
            fetch('/login', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ password: p })
            }).then(r => r.json()).then(d => {
                if(d.success) {
                    localStorage.setItem('nexus_auth', 'true');
                    document.getElementById('login-overlay').style.display = 'none';
                    showToast('Login Berhasil', 'success');
                    loadFiles();
                } else {
                    showToast('Password Salah!', 'error');
                }
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }
        if(localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');

        socket.on('log', d => {
            const l = document.getElementById('logs');
            l.innerHTML += d.replace(/\x1b\[31m/g, '<span class="ansi-red">')
                               .replace(/\x1b\[32m/g, '<span class="ansi-green">')
                               .replace(/\x1b\[33m/g, '<span class="ansi-yellow">')
                               .replace(/\x1b\[36m/g, '<span class="ansi-cyan">')
                               .replace(/\x1b\[0m/g, '</span>');
            l.scrollTop = l.scrollHeight;
        });

        socket.on('stats', s => {
            document.getElementById('stat-ram').innerText = s.ram;
            document.getElementById('stat-cpu').innerText = s.cpu;
            document.getElementById('stat-time').innerText = s.time;
            
            const dot = document.getElementById('stat-dot');
            const txt = document.getElementById('stat-text');
            if(s.status === 'ONLINE') {
                dot.classList.add('online');
                txt.innerText = 'ONLINE';
                txt.style.color = 'var(--success)';
            } else {
                dot.classList.remove('online');
                txt.innerText = 'OFFLINE';
                txt.style.color = 'var(--text-mute)';
            }
        });

        socket.on('notify', d => showToast(d.msg, d.type));

        document.getElementById('cmd').addEventListener('keydown', e => {
            if(e.key === 'Enter' && e.target.value.trim()) {
                socket.emit('input', e.target.value);
                e.target.value = '';
            }
        });

        function switchPage(id) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById('p-'+id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'files') loadFiles();
        }

        function req(url) {
            fetch(url, {method: 'POST'}).then(r=>r.json()).then(d => {
                showToast(d.msg, d.success ? 'success' : 'error');
                if(url === '/restart') setTimeout(() => req('/start'), 2500);
            });
        }

        function showToast(msg, type = 'success') {
            const box = document.getElementById('toast-box');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `<span>${msg}</span> <span style="cursor:pointer" onclick="this.parentElement.remove()">âœ•</span>`;
            box.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        function loadFiles() {
            fetch('/files').then(r=>r.json()).then(files => {
                const list = document.getElementById('file-list');
                list.innerHTML = '';
                if(files.length === 0) list.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-mute)">Belum ada file diupload</div>';
                
                files.forEach(f => {
                    const isZip = f.name.endsWith('.zip');
                    list.innerHTML += `
                    <div class="file-row">
                        <div class="file-icon">${f.isDir ? 'ðŸ“‚' : 'ðŸ“„'}</div>
                        <div class="file-name">${f.name}</div>
                        <div class="file-actions">
                            ${isZip ? `<button class="btn" onclick="act('/unzip','${f.name}')">Extract</button>` : ''}
                            <button class="btn btn-danger" onclick="act('/delete','${f.name}')">Del</button>
                        </div>
                    </div>`;
                });
            });
        }

        function act(url, name) {
            if(confirm('Yakin ingin melanjutkan?')) {
                fetch(url, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({filename: name})
                }).then(r=>r.json()).then(d => {
                    showToast(d.msg, d.success?'success':'error');
                    loadFiles();
                });
            }
        }

        function upload() {
            const fd = new FormData();
            fd.append('file', document.getElementById('up').files[0]);
            showToast('Mengupload file...', 'warning');
            fetch('/upload', {method:'POST', body:fd}).then(() => {
                showToast('Upload Selesai', 'success');
                loadFiles();
            });
        }
    </script>
</body>
</html>