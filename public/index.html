<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS DASHBOARD</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="toast-area"></div>

<div id="auth">
    <div class="auth-box">
        <h2 style="letter-spacing: -1px; margin-bottom: 5px;">SYSTEM LOGIN</h2>
        <p style="color: var(--text-mute); font-size: 12px;">Masukkan kunci akses administrator</p>
        <input type="password" id="pass" class="auth-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off">
        <button onclick="login()" class="btn btn-primary" style="width: 100%; justify-content: center;">MASUK DASHBOARD</button>
    </div>
</div>

<nav>
    <div class="brand"><span>âš¡</span> NEXUS</div>
    <div class="tabs">
        <div class="tab active" onclick="page('console')">Console</div>
        <div class="tab" onclick="page('files')">Files</div>
    </div>
</nav>

<main id="p-console" class="page active">
    <div class="stats-grid">
        <div class="card">
            <div class="card-label">Status</div>
            <div class="card-value"><span id="st-dot" class="status-dot"></span><span id="st-txt" style="font-size:14px">OFFLINE</span></div>
        </div>
        <div class="card">
            <div class="card-label">RAM Usage</div>
            <div class="card-value" id="st-ram">-- MB</div>
        </div>
        <div class="card">
            <div class="card-label">Uptime</div>
            <div class="card-value" id="st-time">--:--:--</div>
        </div>
        <div class="card">
            <div class="card-label">Host Memory</div>
            <div class="card-value" id="st-total">-- GB</div>
        </div>
    </div>

    <div class="terminal-wrapper">
        <div class="logs" id="logs"></div>
        <div class="input-bar">
            <span class="prompt">âžœ</span>
            <input type="text" id="cmd" class="cmd-in" placeholder="Ketik perintah command disini..." autocomplete="off">
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="req('/start')">â–¶ Start System</button>
        <button class="btn" onclick="req('/restart')">â†» Restart</button>
        <button class="btn btn-danger" onclick="req('/stop')">â–  Terminate</button>
    </div>
</main>

<main id="p-files" class="page">
    <div class="controls" style="justify-content: flex-end;">
        <button class="btn btn-primary" onclick="document.getElementById('up').click()">+ Upload Zip</button>
        <input type="file" id="up" style="display: none;" onchange="upload()">
    </div>
    <div class="file-list" id="file-list"></div>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();

    if (localStorage.getItem('nexus_auth') === 'true') {
        document.getElementById('auth').style.display = 'none';
    }

    function login() {
        const pass = document.getElementById('pass').value;
        fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pass })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                localStorage.setItem('nexus_auth', 'true');
                document.getElementById('auth').style.display = 'none';
                toast('Login Berhasil', 'success');
                loadFiles();
            } else {
                toast('Password Salah', 'error');
            }
        });
    }

    document.getElementById('pass').addEventListener('keydown', e => {
        if (e.key === 'Enter') login();
    });

    socket.on('log', data => {
        const logs = document.getElementById('logs');
        logs.innerHTML += data.replace(/\x1b\[31m/g, '<span class="ansi-red">')
                              .replace(/\x1b\[32m/g, '<span class="ansi-green">')
                              .replace(/\x1b\[33m/g, '<span class="ansi-yellow">')
                              .replace(/\x1b\[36m/g, '<span class="ansi-cyan">')
                              .replace(/\x1b\[0m/g, '</span>');
        logs.scrollTop = logs.scrollHeight;
    });

    socket.on('stats', stats => {
        document.getElementById('st-ram').innerText = stats.ram;
        document.getElementById('st-total').innerText = stats.totalRam;
        document.getElementById('st-time').innerText = stats.uptime;

        const dot = document.getElementById('st-dot');
        const txt = document.getElementById('st-txt');
        if (stats.status === 'ONLINE') {
            dot.classList.add('on');
            txt.innerText = 'ONLINE';
            txt.style.color = 'var(--success)';
        } else {
            dot.classList.remove('on');
            txt.innerText = 'OFFLINE';
            txt.style.color = 'var(--text-mute)';
        }
    });

    socket.on('notify', notif => toast(notif.msg, notif.type));

    function req(url) {
        fetch(url, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            toast(data.msg || 'Command Sent', data.success ? 'success' : 'error');
            if (url === '/restart') setTimeout(() => req('/start'), 2500);
        });
    }

    document.getElementById('cmd').addEventListener('keydown', e => {
        if (e.key === 'Enter' && e.target.value.trim()) {
            socket.emit('input', e.target.value);
            e.target.value = '';
        }
    });

    function page(id) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById('p-' + id).classList.add('active');
        event.target.classList.add('active');
        if (id === 'files') loadFiles();
    }

    function toast(msg, type = 'success') {
        const area = document.getElementById('toast-area');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = msg;
        area.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function loadFiles() {
        fetch('/files')
        .then(res => res.json())
        .then(files => {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            if (files.length === 0) {
                list.innerHTML = '<div style="padding:40px;text-align:center;color:#555">Folder Kosong</div>';
            } else {
                files.forEach(f => {
                    const isZip = f.name.endsWith('.zip');
                    list.innerHTML += `
                    <div class="file-row">
                        <div style="font-size:18px;margin-right:12px">${f.isDir ? 'ðŸ“‚' : 'ðŸ“„'}</div>
                        <div class="file-name">${f.name}</div>
                        <div style="font-size:12px;color:#666;margin-right:20px">${f.size}</div>
                        <div style="display:flex;gap:8px">
                            ${isZip ? `<button class="btn" style="padding:6px 12px;font-size:11px" onclick="act('/unzip','${f.name}')">Extract</button>` : ''}
                            <button class="btn btn-danger" style="padding:6px 12px;font-size:11px" onclick="act('/delete','${f.name}')">Del</button>
                        </div>
                    </div>`;
                });
            }
        });
    }

    function act(url, filename) {
        if (confirm('Lanjutkan?')) {
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            })
            .then(res => res.json())
            .then(data => {
                toast(data.msg, data.success ? 'success' : 'error');
                loadFiles();
            });
        }
    }

    function upload() {
        const fileInput = document.getElementById('up');
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        toast('Mengupload...', 'success');
        fetch('/upload', { method: 'POST', body: formData })
        .then(() => {
            toast('Selesai');
            loadFiles();
        });
    }
</script>
</body>
</html>