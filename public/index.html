<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CYBER PANEL ELITE</title>
  <link rel="stylesheet" href="/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="loginOverlay" class="login-overlay">
    <div class="login-card">
      <div class="login-header">
        <span class="glitch">NEXUS SECURE</span>
        <span class="sub">ADMIN ACCESS</span>
      </div>
      <input type="password" id="password" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button class="btn-glow" onclick="login()">AUTHENTICATE</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="logo">‚ö°NEXUS</span>
        <button class="collapse-btn" onclick="toggleSidebar()">‚óÄ</button>
      </div>
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-page="dashboard">üìä DASHBOARD</a>
        <a href="#" class="nav-item" data-page="console">üíª CONSOLE</a>
        <a href="#" class="nav-item" data-page="terminal">üñ•Ô∏è TERMINAL</a>
        <a href="#" class="nav-item" data-page="files">üìÅ FILES</a>
        <a href="#" class="nav-item" data-page="settings">‚öôÔ∏è SETTINGS</a>
      </nav>
      <div class="sidebar-footer">
        <button class="theme-toggle" onclick="toggleTheme()">üåó</button>
        <button class="logout" onclick="logout()">‚§ø LOGOUT</button>
      </div>
    </aside>

    <main class="content">
      <div id="toastContainer" class="toast-container"></div>

      <section id="page-dashboard" class="page active">
        <h2 class="page-title">SYSTEM DASHBOARD</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">RAM</div>
            <div class="stat-value" id="statRam">-- MB</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">CPU LOAD</div>
            <div class="stat-value" id="statCpu">--%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">DISK USED</div>
            <div class="stat-value" id="statDisk">-- / --</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">UPTIME</div>
            <div class="stat-value" id="statUptime">--:--</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">BOT STATUS</div>
            <div class="stat-value" id="statBot"><span class="dot offline"></span> OFFLINE</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">NETWORK</div>
            <div class="stat-value" id="statNetwork">--</div>
          </div>
        </div>
      </section>

      <section id="page-console" class="page">
        <div class="console-header">
          <h2>BOT CONTROL</h2>
          <div class="console-actions">
            <button class="btn-cyber" onclick="fetch('/api/bot/start',{method:'POST'}).then(r=>r.json()).then(d=>showToast(d.msg))">‚ñ∂ START</button>
            <button class="btn-cyber" onclick="fetch('/api/bot/restart',{method:'POST'}).then(r=>r.json()).then(d=>showToast(d.msg))">‚Üª RESTART</button>
            <button class="btn-cyber" onclick="fetch('/api/bot/stop',{method:'POST'}).then(r=>r.json()).then(d=>showToast(d.msg))">‚ñ† STOP</button>
          </div>
        </div>
        <div class="terminal">
          <div class="terminal-output" id="botLogs"></div>
          <div class="terminal-input-line">
            <span class="prompt">‚ûú</span>
            <input type="text" id="botInput" class="terminal-input-field" placeholder="command...">
          </div>
        </div>
      </section>

      <section id="page-terminal" class="page">
        <h2>REMOTE SHELL</h2>
        <div class="terminal">
          <div class="terminal-output" id="shellLogs"></div>
          <div class="terminal-input-line">
            <span class="prompt">$</span>
            <input type="text" id="shellInput" class="terminal-input-field" placeholder="shell command...">
          </div>
        </div>
      </section>

      <section id="page-files" class="page">
        <div class="file-toolbar">
          <span class="current-path" id="currentPath">/storage</span>
          <input type="file" id="fileUpload" multiple style="display:none">
          <button class="btn-cyber" onclick="document.getElementById('fileUpload').click()">UPLOAD</button>
          <button class="btn-cyber" onclick="newFolder()">üìÅ NEW FOLDER</button>
        </div>
        <div class="file-grid" id="fileList"></div>
        <div id="fileEditor" class="file-editor hidden">
          <textarea id="editorContent" class="editor-textarea"></textarea>
          <div class="editor-actions">
            <button class="btn-cyber" onclick="saveFile()">SAVE</button>
            <button class="btn-cyber" onclick="closeEditor()">CLOSE</button>
          </div>
        </div>
      </section>

      <section id="page-settings" class="page">
        <h2>ENVIRONMENT VARIABLES</h2>
        <div class="settings-group">
          <label>TOKEN</label>
          <input type="text" id="envToken" placeholder="Telegram bot token">
          <label>API_KEY</label>
          <input type="text" id="envApiKey" placeholder="API key">
          <label>SECRET</label>
          <input type="text" id="envSecret" placeholder="Secret">
          <button class="btn-cyber" onclick="saveEnv()">SAVE</button>
        </div>
      </section>
    </main>
  </div>

  <footer class="cyber-footer">
    <a href="https://wa.me/628123456789" target="_blank">üì± WhatsApp</a>
    <a href="https://t.me/cybernexus" target="_blank">üìû Telegram</a>
    <span>¬© 2025 NEXUS ELITE</span>
  </footer>

  <script>
    const socket = io();
    let currentPath = '';
    let currentFile = null;

    if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');

    document.getElementById('password').addEventListener('keydown', e => { if(e.key === 'Enter') login(); });

    async function login() {
      const pass = document.getElementById('password').value;
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: pass })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('loginOverlay').style.display = 'none';
        showToast('Access granted', 'success');
        loadDashboardStats();
        loadFiles();
      } else {
        showToast('Access denied', 'error');
      }
    }

    async function logout() {
      await fetch('/logout', { method: 'POST' });
      localStorage.removeItem('nexus_auth');
      location.reload();
    }

    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('collapsed');
    }

    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        const page = item.dataset.page;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${page}`).classList.add('active');
        if (page === 'files') loadFiles();
        if (page === 'dashboard') loadDashboardStats();
      });
    });

    socket.on('system-stats', stats => {
      document.getElementById('statRam').innerText = stats.ram;
      document.getElementById('statCpu').innerText = stats.cpu + '%';
      const botStat = document.getElementById('statBot');
      if (botStat) {
        botStat.innerHTML = stats.bot === 'ONLINE' ? '<span class="dot online"></span> ONLINE' : '<span class="dot offline"></span> OFFLINE';
      }
    });

    socket.on('bot-log', data => {
      const el = document.getElementById('botLogs');
      if (!el) return;
      el.innerHTML += ansiToHtml(data);
      el.scrollTop = el.scrollHeight;
    });

    socket.on('terminal-output', data => {
      const el = document.getElementById('shellLogs');
      if (!el) return;
      el.innerHTML += ansiToHtml(data);
      el.scrollTop = el.scrollHeight;
    });

    function ansiToHtml(text) {
      return text.replace(/\x1b\[31m/g, '<span style="color:#ff3e3e">')
                 .replace(/\x1b\[32m/g, '<span style="color:#00ff9f">')
                 .replace(/\x1b\[33m/g, '<span style="color:#f0e68c">')
                 .replace(/\x1b\[36m/g, '<span style="color:#2afcff">')
                 .replace(/\x1b\[0m/g, '</span>')
                 .replace(/\n/g, '<br>');
    }

    document.getElementById('botInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && e.target.value) {
        socket.emit('bot-input', e.target.value);
        e.target.value = '';
      }
    });

    document.getElementById('shellInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && e.target.value) {
        socket.emit('terminal-input', e.target.value);
        e.target.value = '';
      }
    });

    async function loadDashboardStats() {
      const res = await fetch('/api/stats');
      const stats = await res.json();
      document.getElementById('statRam').innerText = stats.ram;
      document.getElementById('statCpu').innerText = stats.cpu + '%';
      const uptime = new Date(stats.uptime * 1000).toISOString().substr(11, 8);
      document.getElementById('statUptime').innerText = uptime;
      const usedGB = (stats.diskUsed / 1e9).toFixed(1);
      const totalGB = (stats.diskTotal / 1e9).toFixed(1);
      document.getElementById('statDisk').innerText = `${usedGB} GB / ${totalGB} GB`;
      document.getElementById('statNetwork').innerText = stats.network.map(n => n.addresses[0]).join(', ');
    }

    async function loadFiles(dir = '') {
      const res = await fetch(`/api/files?path=${encodeURIComponent(dir)}`);
      const files = await res.json();
      const container = document.getElementById('fileList');
      container.innerHTML = '';
      if (dir) {
        const up = document.createElement('div');
        up.className = 'file-item';
        up.innerHTML = '<span class="file-icon">üìÅ</span><span class="file-name">..</span>';
        up.onclick = () => loadFiles(dir.split('/').slice(0, -1).join('/'));
        container.appendChild(up);
      }
      files.forEach(f => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `<span class="file-icon">${f.isDirectory ? 'üìÅ' : 'üìÑ'}</span><span class="file-name">${f.name}</span>`;
        div.onclick = () => {
          if (f.isDirectory) {
            loadFiles(dir ? dir + '/' + f.name : f.name);
          } else {
            openFile(dir ? dir + '/' + f.name : f.name);
          }
        };
        container.appendChild(div);
      });
      document.getElementById('currentPath').innerText = '/storage' + (dir ? '/' + dir : '');
      currentPath = dir;
    }

    async function openFile(filePath) {
      const res = await fetch(`/api/file?path=${encodeURIComponent(filePath)}`);
      const data = await res.json();
      document.getElementById('editorContent').value = data.content;
      document.getElementById('fileEditor').classList.remove('hidden');
      currentFile = filePath;
    }

    async function saveFile() {
      const content = document.getElementById('editorContent').value;
      await fetch('/api/file', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentFile, content })
      });
      showToast('File saved');
      closeEditor();
    }

    function closeEditor() {
      document.getElementById('fileEditor').classList.add('hidden');
      currentFile = null;
    }

    document.getElementById('fileUpload').addEventListener('change', async (e) => {
      const formData = new FormData();
      for (let file of e.target.files) formData.append('files', file);
      formData.append('dest', currentPath);
      await fetch('/api/upload', { method: 'POST', body: formData });
      showToast('Upload complete');
      loadFiles(currentPath);
    });

    async function newFolder() {
      const name = prompt('Folder name:');
      if (!name) return;
      const fullPath = currentPath ? currentPath + '/' + name : name;
      await fetch('/api/mkdir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: fullPath })
      });
      loadFiles(currentPath);
    }

    function showToast(msg, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerText = msg;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function saveEnv() {
      const token = document.getElementById('envToken').value;
      const apiKey = document.getElementById('envApiKey').value;
      const secret = document.getElementById('envSecret').value;
      fetch('/api/env', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, apiKey, secret })
      }).then(() => showToast('Environment updated'));
    }
  </script>
</body>
</html>