<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS CONTROL PANEL</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <div class="bg-glow">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div id="login-layer" class="login-overlay">
        <div class="login-card">
            <div style="font-size: 48px; margin-bottom: 10px;">‚ö°</div>
            <h2 style="color:white; font-weight:800; margin-bottom: 5px;">NEXUS ACCESS</h2>
            <p style="color:#71717a; font-size:13px;">Secure Terminal Gateway</p>
            <input type="password" id="auth-token" class="login-inp" placeholder="TOKEN AKSES" autocomplete="off">
            <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; justify-content: center; padding: 14px;">VERIFIKASI</button>
        </div>
    </div>

    <nav class="glass">
        <div class="brand"><span>‚ö°</span> NEXUS</div>
        <div class="nav-pill">
            <div class="nav-item active" onclick="switchTab('console', this)"><span>üíª</span> Terminal</div>
            <div class="nav-item" onclick="switchTab('files', this)"><span>üìÇ</span> Files</div>
        </div>
        <button class="theme-btn" onclick="document.body.classList.toggle('light')">üåó</button>
    </nav>

    <div class="container">
        <div id="tab-console" class="view-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header"><span class="stat-icon">üíæ</span><span class="stat-title">RAM Usage</span></div>
                    <div class="stat-value" id="val-ram">-- MB</div>
                    <div class="progress-bg"><div class="progress-fill" style="width: 45%; background: #6366f1;"></div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span class="stat-icon">‚öôÔ∏è</span><span class="stat-title">CPU Load</span></div>
                    <div class="stat-value" id="val-cpu">-- %</div>
                    <div class="progress-bg"><div class="progress-fill" style="width: 12%; background: #22d3ee;"></div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span class="stat-icon">üìÄ</span><span class="stat-title">Storage</span></div>
                    <div class="stat-value">3.2 GB</div>
                    <div class="progress-bg"><div class="progress-fill" style="width: 68%; background: #a855f7;"></div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span class="stat-icon">‚è±Ô∏è</span><span class="stat-title">Uptime</span></div>
                    <div class="stat-value" id="val-up">--</div>
                    <div class="progress-bg"><div class="progress-fill" style="width: 100%; background: #10b981;"></div></div>
                </div>
            </div>

            <div class="terminal-box">
                <div class="term-header">
                    <div class="dot" style="background:#ef4444"></div>
                    <div class="dot" style="background:#f59e0b"></div>
                    <div class="dot" style="background:#10b981"></div>
                    <span class="term-title">root@nexus:~</span>
                    <div style="margin-left: 10px; display:flex; gap:6px;">
                        <button onclick="api('/proc/start')" style="background:none; border:none; color:#10b981; cursor:pointer;">‚ñ∂</button>
                        <button onclick="api('/proc/stop')" style="background:none; border:none; color:#f43f5e; cursor:pointer;">‚ñ†</button>
                    </div>
                </div>
                <div id="term-out" class="term-body"></div>
                <div class="term-input-area">
                    <span style="color:#10b981; font-weight:bold; font-family:'JetBrains Mono'">‚ûú</span>
                    <input type="text" id="term-in" class="term-input" placeholder="Type a command..." autocomplete="off">
                </div>
            </div>
        </div>

        <div id="tab-files" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div>
                    <h2 style="font-weight:700; font-size: 24px;">File Explorer</h2>
                    <p style="color:var(--text-muted); font-size:13px;">Manage server files realtime</p>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="document.getElementById('file-up').click()">‚òÅ Upload</button>
                    <button class="btn btn-ghost" onclick="fetchFiles()">‚Üª</button>
                    <input type="file" id="file-up" hidden onchange="processUpload()">
                </div>
            </div>
            <div id="file-wrapper" class="file-grid"></div>
        </div>
    </div>

    <script>
        const socket = io();
        const introLines = [
            "[nexus] Booting system kernel...",
            "[nexus] Loading modules: \x1b[34mauth\x1b[0m, \x1b[34mfilesystem\x1b[0m, \x1b[34msocket\x1b[0m",
            "[nexus] \x1b[32m‚úî Database connected successfully\x1b[0m",
            "[nexus] \x1b[32m‚úî WebSocket ready on port 3000\x1b[0m",
            "[nexus] System is ready. Welcome back, Admin."
        ];
        
        function runIntro() {
            let i = 0;
            const t = document.getElementById('term-out');
            t.innerHTML = '';
            function type() {
                if(i < introLines.length) {
                    const l = introLines[i].replace(/\x1b\[32m/g, '<span class="ansi-green">')
                                           .replace(/\x1b\[34m/g, '<span class="ansi-blue">')
                                           .replace(/\x1b\[0m/g, '</span>');
                    t.innerHTML += `<div style="margin-bottom:4px">${l}</div>`;
                    i++; setTimeout(type, 300);
                }
            }
            type();
        }

        const savedToken = localStorage.getItem('nx_token');
        if(savedToken) verifySession(savedToken);

        function attemptLogin() {
            const t = document.getElementById('auth-token').value;
            if(t) verifySession(t);
        }

        function verifySession(t) {
            fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: t})
            }).then(r=>r.json()).then(d=>{
                if(d.success) {
                    localStorage.setItem('nx_token', t);
                    document.getElementById('login-layer').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('login-layer').style.display = 'none';
                        runIntro();
                    }, 500);
                    fetchFiles();
                } else alert('Token Salah');
            });
        }

        const getHeaders = () => ({ 'Authorization': localStorage.getItem('nx_token'), 'Content-Type': 'application/json' });

        document.getElementById('term-in').addEventListener('keydown', e => {
            if(e.key === 'Enter') {
                const cmd = e.target.value;
                if(cmd.trim()) {
                    document.getElementById('term-out').innerHTML += `<div><span style="color:#10b981">‚ûú</span> ${cmd}</div>`;
                    socket.emit('cmd', cmd);
                }
                e.target.value = '';
            }
        });

        socket.on('log', d => {
            const t = document.getElementById('term-out');
            let f = d.replace(/\n/g, '<br>')
                     .replace(/\x1b\[32m/g, '<span class="ansi-green">')
                     .replace(/\x1b\[31m/g, '<span class="ansi-red">')
                     .replace(/\x1b\[0m/g, '</span>');
            t.innerHTML += `<div>${f}</div>`;
            t.scrollTop = t.scrollHeight;
        });

        socket.on('usage', d => {
            document.getElementById('val-ram').innerText = d.procRam + ' MB';
            document.getElementById('val-cpu').innerText = d.cpu + ' %';
            document.getElementById('val-up').innerText = (d.uptime / 3600).toFixed(1) + ' H';
        });

        function fetchFiles() {
            fetch('/files/list', {method: 'POST', headers: getHeaders()})
            .then(r=>r.json()).then(d => {
                const w = document.getElementById('file-wrapper');
                w.innerHTML = '';
                if(d.data) {
                    d.data.forEach(f => {
                        w.innerHTML += `
                        <div class="file-item">
                            <div class="f-actions">
                                <button class="btn btn-ghost" style="padding:6px" onclick="action('/files/delete','${f.name}')">üóë</button>
                                ${f.name.endsWith('.zip') ? `<button class="btn btn-ghost" style="padding:6px" onclick="action('/files/unzip','${f.name}')">üì¶</button>` : ''}
                            </div>
                            <div class="f-icon">${f.isDir ? 'üìÅ' : 'üìÑ'}</div>
                            <div>
                                <div class="f-name">${f.name}</div>
                                <div class="f-meta">${f.isDir ? 'Folder' : (f.size/1024).toFixed(1) + ' KB'}</div>
                            </div>
                        </div>`;
                    });
                }
            });
        }

        function processUpload() {
            const f = document.getElementById('file-up').files[0];
            if(!f) return;
            const fd = new FormData();
            fd.append('file', f);
            fetch('/upload', { method: 'POST', body: fd }).then(() => fetchFiles());
        }

        function action(u, n) {
            if(confirm('Action?')) fetch(u, { method: 'POST', headers: getHeaders(), body: JSON.stringify({filename: n}) }).then(() => fetchFiles());
        }

        function switchTab(id, el) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            el.classList.add('active');
        }

        function api(u) { fetch(u, {method:'POST', headers: getHeaders()}); }
    </script>
</body>
</html>
