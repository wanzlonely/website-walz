<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS CONTROL PANEL</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="bg-glow">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <div id="login-layer" class="login-overlay">
        <div class="login-card">
            <div style="font-size: 48px; margin-bottom: 10px;">‚ö°</div>
            <h2 style="color:white; font-weight:800; margin-bottom: 5px;">NEXUS ACCESS</h2>
            <p style="color:#71717a; font-size:13px;">Secure Terminal Gateway</p>
            <input type="password" id="auth-token" class="login-inp" placeholder="TOKEN AKSES" autocomplete="off">
            <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; justify-content:center; padding:14px;">
                VERIFIKASI
            </button>
        </div>
    </div>

    <nav class="glass">
        <div class="brand">
            <span>‚ö°</span> NEXUS
        </div>
        
        <div class="nav-pill">
            <div class="nav-item active" onclick="switchTab('console', this)">
                <span>üíª</span> Terminal
            </div>
            <div class="nav-item" onclick="switchTab('files', this)">
                <span>üìÇ</span> Files
            </div>
        </div>

        <button class="theme-btn" onclick="document.body.classList.toggle('light')">
            üåó
        </button>
    </nav>

    <div class="container">
        <div id="tab-console" class="view-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üíæ</span>
                        <span class="stat-title">RAM Usage</span>
                    </div>
                    <div class="stat-value" id="val-ram">247 MB</div>
                    <div class="progress-bg"><div class="progress-fill" style="width:45%; background:#6366f1;"></div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">‚öôÔ∏è</span>
                        <span class="stat-title">CPU Load</span>
                    </div>
                    <div class="stat-value" id="val-cpu">12 %</div>
                    <div class="progress-bg"><div class="progress-fill" style="width:12%; background:#22d3ee;"></div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üìÄ</span>
                        <span class="stat-title">Storage</span>
                    </div>
                    <div class="stat-value">3.2 GB</div>
                    <div class="progress-bg"><div class="progress-fill" style="width:68%; background:#a855f7;"></div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">‚è±Ô∏è</span>
                        <span class="stat-title">Uptime</span>
                    </div>
                    <div class="stat-value">14d 7h</div>
                    <div class="progress-bg"><div class="progress-fill" style="width:100%; background:#10b981;"></div></div>
                </div>
            </div>

            <div class="terminal-box">
                <div class="term-header">
                    <div class="dot" style="background:#ef4444"></div>
                    <div class="dot" style="background:#f59e0b"></div>
                    <div class="dot" style="background:#10b981"></div>
                    <span class="term-title">root@nexus:\~</span>
                    <div style="margin-left:10px; display:flex; gap:6px;">
                        <button onclick="api('/proc/start')" style="background:none;border:none;color:#10b981;cursor:pointer;font-size:16px;">‚ñ∂</button>
                        <button onclick="api('/proc/stop')" style="background:none;border:none;color:#f43f5e;cursor:pointer;font-size:16px;">‚ñ†</button>
                    </div>
                </div>
                <div id="term-out" class="term-body"></div>
                <div class="term-input-area">
                    <span style="color:#10b981; font-weight:bold; font-family:'JetBrains Mono'">‚ûú</span>
                    <input type="text" id="term-in" class="term-input" placeholder="Type a command..." autocomplete="off">
                </div>
            </div>
        </div>

        <div id="tab-files" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div>
                    <h2 style="font-weight:700; font-size:24px;">File Explorer</h2>
                    <p style="color:var(--text-muted); font-size:13px;">Manage server files realtime</p>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="document.getElementById('file-up').click()">‚òÅ Upload</button>
                    <button class="btn btn-ghost" onclick="fetchFiles()">‚Üª</button>
                    <input type="file" id="file-up" hidden onchange="processUpload()">
                </div>
            </div>
            <div id="file-wrapper" class="file-grid"></div>
        </div>
    </div>

    <div id="toast-area" style="position:fixed; top:24px; right:24px; z-index:9999; display:flex; flex-direction:column; gap:10px;"></div>

    <script>
        const socket = io();

        const introLines = [
            "[nexus] Booting system kernel...",
            "[nexus] Loading modules: \x1b[34mauth\x1b[0m, \x1b[34mfilesystem\x1b[0m, \x1b[34msocket\x1b[0m",
            "[nexus] \x1b[32m‚úî Database connected successfully\x1b[0m",
            "[nexus] \x1b[32m‚úî WebSocket ready on port 3000\x1b[0m",
            "[nexus] System is ready. Welcome back, Admin."
        ];

        function runIntro() {
            let i = 0;
            const term = document.getElementById('term-out');
            term.innerHTML = '';

            function typeLine() {
                if (i < introLines.length) {
                    let line = introLines[i]
                        .replace(/\x1b\[32m/g, '<span class="ansi-green">')
                        .replace(/\x1b\[34m/g, '<span class="ansi-blue">')
                        .replace(/\x1b\[0m/g, '</span>');

                    term.innerHTML += `<div style="margin-bottom:4px">${line}</div>`;
                    i++;
                    setTimeout(typeLine, 300);
                }
            }
            typeLine();
        }

        const savedToken = localStorage.getItem('nx_token');
        if (savedToken) verifySession(savedToken);

        function attemptLogin() {
            const token = document.getElementById('auth-token').value.trim();
            if (!token) return alert('Masukkan Token');
            verifySession(token);
        }

        function verifySession(token) {
            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    localStorage.setItem('nx_token', token);
                    const loginLayer = document.getElementById('login-layer');
                    loginLayer.style.opacity = '0';
                    setTimeout(() => {
                        loginLayer.style.display = 'none';
                        runIntro();
                    }, 500);
                    fetchFiles();
                } else {
                    alert('Token Salah');
                }
            })
            .catch(() => alert('Server Error'));
        }

        function getHeaders() {
            return {
                'Authorization': localStorage.getItem('nx_token'),
                'Content-Type': 'application/json'
            };
        }

        document.getElementById('term-in').addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                const cmd = e.target.value.trim();
                if (cmd) {
                    document.getElementById('term-out').innerHTML +=
                        `<div><span style="color:#10b981">‚ûú</span> ${cmd}</div>`;
                    socket.emit('cmd', cmd);
                }
                e.target.value = '';
            }
        });

        socket.on('log', data => {
            const termOut = document.getElementById('term-out');
            let formatted = data
                .replace(/\n/g, '<br>')
                .replace(/\x1b\[32m/g, '<span class="ansi-green">')
                .replace(/\x1b\[31m/g, '<span class="ansi-red">')
                .replace(/\x1b\[0m/g, '</span>');

            termOut.innerHTML += `<div>${formatted}</div>`;
            termOut.scrollTop = termOut.scrollHeight;
        });

        socket.on('usage', data => {
            document.getElementById('val-ram').innerText = `${data.ram} MB`;
            document.getElementById('val-cpu').innerText = `${data.cpu} %`;
        });

        function fetchFiles() {
            fetch('/files/list', { method: 'POST', headers: getHeaders() })
                .then(r => r.json())
                .then(res => {
                    const wrapper = document.getElementById('file-wrapper');
                    wrapper.innerHTML = '';

                    if (res.data && Array.isArray(res.data)) {
                        res.data.forEach(f => {
                            const meta = f.isDir ? 'Folder' : `${(f.size / 1024).toFixed(1)} KB`;
                            wrapper.innerHTML += `
                                <div class="file-item">
                                    <div class="f-actions">
                                        <button class="btn btn-ghost" style="padding:6px"
                                            onclick="deleteFile('${f.name.replace(/'/g, "\\'")}')">üóë</button>
                                    </div>
                                    <div class="f-icon">${f.isDir ? 'üìÅ' : 'üìÑ'}</div>
                                    <div>
                                        <div class="f-name">${f.name}</div>
                                        <div class="f-meta">${meta}</div>
                                    </div>
                                </div>`;
                        });
                    }
                })
                .catch(err => console.error('Fetch files error:', err));
        }

        function switchTab(id, el) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            el.classList.add('active');
        }

        function api(url) {
            fetch(url, { method: 'POST', headers: getHeaders() })
                .catch(err => console.error('API error:', err));
        }

        function deleteFile(name) {
            if (!confirm(`Yakin ingin menghapus "${name}"?`)) return;

            fetch('/files/delete', {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ name })
            })
            .then(() => fetchFiles())
            .catch(() => alert('Gagal menghapus file'));
        }

        function processUpload() {
            const fileInput = document.getElementById('file-up');
            const file = fileInput.files[0];
            if (!file) return alert('Pilih file terlebih dahulu!');

            const formData = new FormData();
            formData.append('file', file);

            fetch('/files/upload', {
                method: 'POST',
                headers: { 'Authorization': localStorage.getItem('nx_token') },
                body: formData
            })
            .then(() => {
                alert('‚úÖ Upload berhasil!');
                fetchFiles();
                fileInput.value = '';
            })
            .catch(() => alert('‚ùå Upload gagal'));
        }
    </script>
</body>
</html>