<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Bot Control</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #09090b; --panel: #18181b; --border: #27272a; --text: #e4e4e7; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; font-family: 'JetBrains Mono', monospace; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 50px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 13px; }
        .stats { display: flex; gap: 15px; color: #a1a1aa; }
        .stats span { color: var(--accent); font-weight: bold; }
        .container { display: flex; flex: 1; overflow: hidden; }
        aside { width: 280px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .upload-box { padding: 15px; border-bottom: 1px solid var(--border); }
        .file-list { flex: 1; overflow-y: auto; padding: 10px; }
        .file-item { background: #202022; border: 1px solid var(--border); padding: 10px; margin-bottom: 8px; border-radius: 4px; }
        .file-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 12px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .dot.on { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .actions { display: flex; gap: 5px; }
        button { flex: 1; padding: 5px; border: none; font-size: 10px; cursor: pointer; color: #fff; border-radius: 3px; }
        .btn-run { background: #27272a; } .btn-run:hover { background: var(--success); color: #000; }
        .btn-stop { background: #3f1515; color: var(--danger); } .btn-stop:hover { background: var(--danger); color: #fff; }
        .btn-edit { background: #27272a; } .btn-edit:hover { background: var(--accent); }
        .btn-del { background: transparent; color: #666; } .btn-del:hover { color: var(--danger); }
        main { flex: 1; background: #000; padding: 15px; display: flex; flex-direction: column; }
        #terminal { flex: 1; background: #0c0c0c; border: 1px solid var(--border); padding: 15px; overflow-y: auto; font-size: 12px; white-space: pre-wrap; color: #ccc; border-radius: 4px; }
        #login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 99; display: flex; align-items: center; justify-content: center; }
        .login-box { text-align: center; }
        input { background: #111; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 4px; margin-top: 10px; text-align: center; }
        .ansi-red { color: #ef4444; } .ansi-green { color: #22c55e; } .ansi-yellow { color: #eab308; } .ansi-blue { color: #3b82f6; }
        #editor-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; padding: 20px; display: none; }
        .editor-win { background: var(--panel); height: 100%; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .editor-head { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        textarea { flex: 1; background: #0c0c0c; color: #fff; padding: 15px; border: none; resize: none; font-size: 13px; }
        @media (max-width: 700px) { .container { flex-direction: column; } aside { height: 40%; width: 100%; } }
    </style>
</head>
<body>
    <div id="login-overlay"><div class="login-box"><h3>ACCESS REQUIRED</h3><input type="password" id="pass" placeholder="Enter Password" onkeyup="if(event.key==='Enter')auth()"></div></div>
    
    <header>
        <div><b>RAILWAY</b> PANEL</div>
        <div class="stats" id="stats">RAM: -</div>
    </header>
    <div class="container">
        <aside>
            <div class="upload-box">
                <form action="/upload" method="POST" enctype="multipart/form-data" style="display:flex; gap:5px;">
                    <input type="file" name="scriptFile" required style="font-size:10px; padding:5px;">
                    <button type="submit" style="background:var(--accent); width:50px;">UP</button>
                </form>
            </div>
            <div class="file-list" id="list"></div>
        </aside>
        <main><div id="terminal"></div></main>
    </div>

    <div id="editor-overlay">
        <div class="editor-win">
            <div class="editor-head"><span id="ed-name"></span><div><button onclick="save()" style="width:60px; background:var(--accent);">SAVE</button><button onclick="closeEd()" style="width:60px; background:var(--danger);">X</button></div></div>
            <textarea id="ed-code"></textarea>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const term = document.getElementById('terminal');
        let active = [];

        socket.on('log', d => {
            term.innerHTML += d.replace(/\x1b\[31m/g, '<span class="ansi-red">').replace(/\x1b\[32m/g, '<span class="ansi-green">').replace(/\x1b\[33m/g, '<span class="ansi-yellow">').replace(/\x1b\[36m/g, '<span class="ansi-blue">').replace(/\x1b\[0m/g, '</span>');
            term.scrollTop = term.scrollHeight;
        });
        socket.on('status_update', l => { active = l; load(); });
        socket.on('sys_stats', s => document.getElementById('stats').innerText = `RAM: ${s.ram} | HOST: ${s.total}`);

        function auth() {
            fetch('/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({password: document.getElementById('pass').value}) })
            .then(r=>r.json()).then(d => { if(d.success) { document.getElementById('login-overlay').style.display='none'; load(); } else alert('Wrong Password'); });
        }
        function load() {
            fetch('/files').then(r=>r.json()).then(files => {
                const l = document.getElementById('list'); l.innerHTML = '';
                files.forEach(f => {
                    const on = active.includes(f);
                    l.innerHTML += `<div class="file-item"><div class="file-head"><span>${f}</span><div class="dot ${on?'on':''}"></div></div><div class="actions">${on ? `<button class="btn-stop" onclick="req('/stop', '${f}')">STOP</button>` : `<button class="btn-run" onclick="req('/start', '${f}')">RUN</button>`}<button class="btn-edit" onclick="edit('${f}')">EDIT</button><button class="btn-del" onclick="del('${f}')">DEL</button></div></div>`;
                });
            });
        }
        function req(u, f) { fetch(u, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({filename:f}) }); }
        function del(f) { if(confirm('Del?')) { req('/delete', f); setTimeout(load, 500); } }
        function edit(f) { fetch('/read', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({filename:f}) }).then(r=>r.json()).then(d=>{ document.getElementById('editor-overlay').style.display='block'; document.getElementById('ed-name').innerText=f; document.getElementById('ed-code').value=d.content; }); }
        function save() { fetch('/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({filename:document.getElementById('ed-name').innerText, content:document.getElementById('ed-code').value}) }).then(()=>closeEd()); }
        function closeEd() { document.getElementById('editor-overlay').style.display='none'; }
    </script>
</body>
</html>
